<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹å¯«æ¿</title>
	<link rel="icon" type="image/svg+xml" href="https://ymdd-image-tw.s3.ap-east-2.amazonaws.com/image/paintbrush-solid-full.svg">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script> 
    <style>
        /* --- CSS æ¨£å¼ --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background-color: #f4f7f9;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }
        .controls {
            margin-bottom: 15px; 
            display: flex;
            flex-direction: column;
            gap: 10px; 
        }
        
        /* å€å¡Š 1 & 2 åˆä½µï¼šå·¥å…·èˆ‡æ¨£å¼æ§åˆ¶ */
        .tool-and-style-controls { 
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 8px 10px; 
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex-wrap: wrap; 
        }

        /* å¯¦ç”¨åŠŸèƒ½åˆ—å®¹å™¨ */
        .utility-options {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex-wrap: wrap; 
        }
        
        /* åœ–ç¤ºå·¥å…·æŒ‰éˆ•æ¨£å¼ (V37.1 èª¿æ•´ font-size) */
        .tool-and-style-controls button[data-mode] {
            padding: 8px 10px; 
            min-width: 40px; 
            cursor: pointer;
            border: 1px solid #007bff;
            border-radius: 4px;
            background-color: #f0f8ff;
            color: #007bff;
            font-size: 18px; /* æé«˜å­—é«”å¤§å°ï¼Œç¢ºä¿ SVG æ¸…æ¥š */
            transition: all 0.2s;
            white-space: nowrap;
        }
        .tool-and-style-controls button[data-mode].active {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }
        /* ç¢ºä¿ Font Awesome åœ–ç¤ºèƒ½è¢«æ­£ç¢ºè‘—è‰²å’Œç¸®æ”¾ */
        .tool-and-style-controls button i {
            color: inherit; /* ç¹¼æ‰¿æŒ‰éˆ•é¡è‰² */
        }


        /* é¡è‰²è¼¸å…¥ã€ç·šå¯¬æ»‘æ¡¿ */
        .tool-and-style-controls input[type="range"] {
            width: 70px; 
            margin-right: 5px;
        }
        
        /* é¡è‰²é¸å–®æŒ‰éˆ• */
        .color-palette-btn {
            width: 25px; 
            height: 25px;
            border-radius: 50%;
            border: 2px solid #ccc;
            cursor: pointer;
            transition: border-color 0.2s;
            padding: 0;
            margin: 0 1px;
            opacity: 0.9;
            box-sizing: content-box;
            background-color: currentColor; 
        }

        /* å¯¦ç”¨åŠŸèƒ½æŒ‰éˆ•é€šç”¨æ¨£å¼ (V37.1 èª¿æ•´å­—é«”å¤§å°) */
        .utility-options > button:not(#resize-canvas-btn):not(#save-image-btn), 
        .utility-options > label[for="background-image-input"] {
            padding: 8px 15px;
            cursor: pointer;
            border: 1px solid #007bff;
            border-radius: 4px;
            background-color: #f0f8ff;
            color: #007bff;
            font-weight: 600;
            font-size: 14px; /* è®“å­—é«”æ›´é©åˆæŒ‰éˆ• */
            transition: all 0.2s;
            white-space: nowrap;
        }

        /* ç‰¹æ®ŠåŠŸèƒ½æŒ‰éˆ•æ¨£å¼ */
        #save-image-btn { 
            padding: 8px 15px;
            cursor: pointer;
            border: 1px solid #17a2b8;
            border-radius: 4px; 
            background-color: #17a2b8; 
            color: white; 
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }
        #resize-canvas-btn { 
            padding: 8px 15px;
            cursor: pointer;
            border: 1px solid #28a745; 
            border-radius: 4px;
            background-color: #28a745; 
            color: white; 
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        /* å°ºå¯¸èª¿æ•´æ§åˆ¶é …çš„ Flex æ¨£å¼ */
        #size-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-left: 0; 
            margin-left: 0; 
            flex-wrap: wrap; 
        }
        
        #size-controls label {
            padding: 0;
            cursor: default;
            border: none;
            background-color: transparent;
            color: #333;
            font-weight: 600;
            white-space: nowrap;
            font-size: 14px;
        }
        #size-controls input[type="number"] {
            width: 70px; 
            padding: 5px; 
            border: 1px solid #ccc; 
            border-radius: 4px;
            font-size: 14px;
        }
        
        /* ç•«å¸ƒå®¹å™¨æ¨£å¼ */
        #canvas-container {
            width: 900px;
            height: 600px;
            border: 1px solid #ccc;
            background-color: #ffffff; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain; 
            position: relative; 
        }

        #c {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

    <h2>ğŸ› ï¸ ç¶²é äº’å‹•ç•«æ¿</h2>

    <div class="controls">
        
        <h3>ç•¶å‰å·¥å…·: <span id="current-tool-display" style="color: #007bff; font-weight: bold;">(ç­†åˆ·)</span></h3>
        
        <div class="utility-options">
			<button id="fullscreen-btn">ğŸ–¥ï¸ å…¨è¢å¹•</button>
            <button id="add-text-btn">ğŸ“ æ–‡å­—æ–¹å¡Š</button>
            
            <label for="background-image-input">ğŸ–¼ï¸ å°å…¥åº•åœ–</label>
            <input type="file" id="background-image-input" accept="image/*" style="display: none;">
            <button id="clear-background-btn">ğŸ—‘ï¸ æ¸…é™¤åº•åœ–</button>
            <button id="clear-all-drawings-btn">ğŸ§¹ æ¸…é™¤ç­†è·¡</button>
            <button id="delete-selected-btn">âŒ åˆªé™¤é¸å–</button>
            
            <div id="size-controls">
                <label for="new-width">å¯¬åº¦ (px)ï¼š</label>
                <input type="number" id="new-width" value="900" min="300">
                <label for="new-height">é«˜åº¦ (px)ï¼š</label>
                <input type="number" id="new-height" value="600" min="300">
                <button id="resize-canvas-btn">ğŸ“ èª¿æ•´å°ºå¯¸</button>
            </div>
            
            <button id="save-image-btn">ğŸ’¾ å„²å­˜ç‚º PNG</button>
        </div>
		        <div class="tool-and-style-controls">
            <button id="brush-mode-btn" data-mode="brush" class="active" title="ç­†åˆ·">
                <i class="fa-solid fa-paintbrush"></i>
            </button>
            <button id="highlighter-mode-btn" data-mode="highlighter" title="è¢å…‰ç­†">
                <i class="fa-solid fa-highlighter"></i>
            </button>
            <button id="eraser-mode-btn" data-mode="eraser" title="æ©¡çš®æ“¦">
                <i class="fa-solid fa-eraser"></i>
            </button> 
            <button id="select-mode-btn" data-mode="select" title="é¸æ“‡/ç§»å‹•">
                <i class="fa-solid fa-up-down-left-right"></i>
            </button>
			<button data-mode="pan" id="pan-mode-btn" title="ç§»å‹•ç•«å¸ƒ (å–®æŒ‡æ‹–æ›³)">
			<i class="fas fa-hand-paper"></i> </button>
            
            <span style="border-left: 1px solid #eee; padding-left: 12px; font-weight: 600;"></span>
            
            <label for="drawing-color" style="font-weight: 600;">é¡è‰²:</label>
            <input type="color" id="drawing-color" value="#007bff">

            <label for="line-width-range" style="font-weight: 600; margin-left: 5px;">ç²—ç´°:</label>
			<input type="range" value="5" min="1" max="100" id="line-width-range" style="width: 70px;">
			<input type="number" value="5" min="1" max="100" id="line-width-number" style="width: 45px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
            
            <span style="border-left: 1px solid #eee; padding-left: 12px; font-weight: 600;">ç­†åŠƒ:</span>
            <button class="color-palette-btn" data-target="brush" data-color="#007bff" style="background-color: #007bff;" title="è—è‰²ç­†åŠƒ"></button>
            <button class="color-palette-btn" data-target="brush" data-color="#000000" style="background-color: #000000;" title="é»‘è‰²ç­†åŠƒ"></button>
            
            <span style="border-left: 1px solid #eee; padding-left: 12px; font-weight: 600;">è¢å…‰:</span>
            <button class="color-palette-btn" data-target="highlighter" data-color="#ffff00" style="background-color: #ffff00;" title="é»ƒè‰²è¢å…‰ç­†"></button>
            <button class="color-palette-btn" data-target="highlighter" data-color="#79f2f2" style="background-color: #79f2f2;" title="è—è‰²è¢å…‰ç­†"></button>
        </div>
        
    </div>

    <div id="canvas-container" style="touch-action: none;">
        <canvas id="c" width="900" height="600"></canvas>
    </div>


<script>
    // *** JavaScript è…³æœ¬ - V38.9 æœ€çµ‚æ•´åˆç‰ˆ (ä¿®å¾©çµæ§‹éŒ¯èª¤ã€åŒ…å«æ‰€æœ‰åŠŸèƒ½) ***
    document.addEventListener('DOMContentLoaded', () => {
        
		// æ‰¾åˆ°æ–°å¢çš„å…¨è¢å¹•æŒ‰éˆ•
const fullscreenBtn = document.getElementById('fullscreen-btn');

/**
 * è™•ç†å…¨è¢å¹•é‚è¼¯
 */
fullscreenBtn.addEventListener('click', () => {
    const docEl = document.documentElement; // æŒ‡å‘ <html> å…ƒç´ 

    if (!document.fullscreenElement) {
        // é€²å…¥å…¨è¢å¹•æ¨¡å¼
        docEl.requestFullscreen().then(() => {
            // é€²å…¥å…¨è¢å¹•å¾Œï¼Œå¦‚æœå…§å®¹è¶…å‡ºè¦–çª—ï¼Œä¿æŒå¯æ²å‹•
            // é€™å¯èƒ½æœƒå› ç€è¦½å™¨è€Œç•°ï¼Œä½†é€šå¸¸å° body/html è¨­ç½® overflow: auto æœ‰åŠ©ç›Š
            document.body.style.overflow = 'auto'; 
            docEl.style.overflow = 'auto'; 
            fullscreenBtn.textContent = 'ğŸ–¥ï¸ é€€å‡ºå…¨è¢å¹•';
        }).catch(err => {
            alert(`é€²å…¥å…¨è¢å¹•å¤±æ•—: ${err.message} (å¯èƒ½éœ€è¦ä½¿ç”¨è€…äº’å‹•æ‰èƒ½å•Ÿç”¨)`);
        });
    } else {
        // é€€å‡ºå…¨è¢å¹•æ¨¡å¼
        document.exitFullscreen().then(() => {
            // æ¢å¾©åŸæœ¬çš„æ²å‹•è¨­å®š (å¦‚æœæœ‰çš„è©±)
            document.body.style.overflow = ''; 
            docEl.style.overflow = ''; 
            fullscreenBtn.textContent = 'ğŸ–¥ï¸ å…¨è¢å¹•';
        });
    }
});
		
        // --- æ ¸å¿ƒè®Šæ•¸èˆ‡åˆå§‹åŒ– ---
        const initialWidth = 900;
        const initialHeight = 600;

        let isPanning = false; 

        const canvas = new fabric.Canvas('c', {Â 
            isDrawingMode: false,
            preserveObjectStacking: true,Â 
            backgroundColor: 'transparent',
            width: initialWidth,Â 
            height: initialHeight,
            isTouchEventSupported: true, 
            selection: false
        });

        const pencilBrush = new fabric.PencilBrush(canvas);
        
        // V38.8: brushSettings ç¨ç«‹å„²å­˜æ¯ç¨®æ¨¡å¼çš„å¯¬åº¦ (width)
        let brushSettings = {
            brush: { brush: pencilBrush, color: '#007bff', width: 5, composite: 'source-over' },
            highlighter: { brush: pencilBrush, color: '#ffff0080', width: 30, composite: 'source-over' },Â 
            eraser: {Â 
                brush: pencilBrush,Â 
                color: 'rgba(150, 150, 150, 0.5)',Â 
                width: 25,Â 
                composite: 'source-over'Â 
            },Â 
            select: { brush: pencilBrush, color: '#000000', width: 1, composite: 'source-over' },
            pan: { brush: pencilBrush, color: '#000000', width: 1, composite: 'source-over' } 
        };
        let currentMode = 'brush';Â 

        // --- DOM å…ƒç´ å¿«å– ---
        const canvasContainer = document.getElementById('canvas-container');Â 
        const toolDisplay = document.getElementById('current-tool-display');
        const colorEl = document.getElementById('drawing-color');
        const widthRangeEl = document.getElementById('line-width-range'); 
        const widthNumberEl = document.getElementById('line-width-number'); 
        
        // ç¬¬äºŒæ¬„åŠŸèƒ½å…ƒç´ 
        const newWidthEl = document.getElementById('new-width');Â 
        const newHeightEl = document.getElementById('new-height');Â 
        const resizeCanvasBtn = document.getElementById('resize-canvas-btn');Â 
        const saveImageBtn = document.getElementById('save-image-btn');Â 
        const bgImageInput = document.getElementById('background-image-input');
        const clearBgBtn = document.getElementById('clear-background-btn');
        const clearAllDrawingsBtn = document.getElementById('clear-all-drawings-btn');
        const addTextBtn = document.getElementById('add-text-btn');
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');


        // å…¶ä»–æŒ‰éˆ•å¿«å–
        const brushModeBtn = document.getElementById('brush-mode-btn');
        const highlighterModeBtn = document.getElementById('highlighter-mode-btn');
        const eraserModeBtn = document.getElementById('eraser-mode-btn');
        const selectModeBtn = document.getElementById('select-mode-btn');
        const panModeBtn = document.getElementById('pan-mode-btn'); 

        
        // ** ç¹ªåœ–/æ–‡å­—å †ç–Šé‚è¼¯ **
        canvas.on('path:created', function(e) {
            const path = e.path;
            path.isEraserPath = (currentMode === 'eraser');
            
            if (currentMode === 'eraser') {
                path.set({Â 
                    globalCompositeOperation: 'destination-out',
                    selectable: false,
                    evented: false,
                    stroke: 'rgba(0,0,0,1)'Â 
                });Â 
                Â 
                canvas.getObjects().forEach(obj => {
                    if (obj.type !== 'i-text') {
                        canvas.bringToFront(obj);
                    }
                });
                canvas.bringToFront(path);
                
            } else {
                path.set({ selectable: false, evented: false });Â 
                canvas.bringToFront(path);
            }
            
            canvas.getObjects().filter(obj => obj.type === 'i-text').forEach(textObj => {
                canvas.bringToFront(textObj);
            });

            canvas.renderAll();Â 
        });

        // é›™æ“Šæ–‡å­—é€²å…¥ç·¨è¼¯
        canvas.on('mouse:dblclick', function(options) {
            if (options.target && options.target.type === 'i-text' && currentMode === 'select') {
                options.target.enterEditing();
                canvas.renderAll();
            }
        });


        /**
         * æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ï¼šè¨­å®šå·¥å…·æ¨¡å¼
         */
        function setToolMode(mode) {
            currentMode = mode;
            
            toolDisplay.textContent = `(${mode.toUpperCase()})`;
            
            document.querySelectorAll('.tool-and-style-controls button[data-mode]').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`[data-mode="${mode}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // --- é è¨­ç‹€æ…‹é‡ç½® ---
            canvas.isDrawingMode = false;
            canvas.selection = false;
            colorEl.disabled = true;
            widthRangeEl.disabled = true;
            canvas.defaultCursor = 'default';
            
            // ç‰©ä»¶äº’å‹•ç‹€æ…‹æ§åˆ¶
            canvas.forEachObject(obj => {
                if (obj.type === 'path') {
                    obj.set({ selectable: false, evented: false });
                } else if (obj.type === 'i-text') {
                    obj.set({ selectable: false, evented: false }); 
                }
            });


            // --- ç§»å‹•æ¨¡å¼ (Pan) ---
            if (mode === 'pan') {
                canvas.defaultCursor = 'grab'; 
                return;
            }

            // --- é¸å–æ¨¡å¼ (Select) ---
            if (mode === 'select') {
                canvas.selection = true;
                canvas.forEachObject(obj => {
                    const isSelectable = (obj.type === 'i-text' || (obj.type === 'path' && obj.isEraserPath === false));
                    obj.set({ selectable: isSelectable, evented: isSelectable }); 
                });
                return;Â 
            }
            
            // --- ç¹ªåœ–/æ“¦é™¤æ¨¡å¼ (Brush, Highlighter, Eraser) ---
            canvas.isDrawingMode = true;Â 
            colorEl.disabled = (mode === 'eraser');
            widthRangeEl.disabled = false;
            canvas.defaultCursor = (mode === 'eraser') ? 'crosshair' : 'default';

            const settings = brushSettings[mode];
            
            // V38.8 ä¿®æ­£ï¼šè®€å–è©²æ¨¡å¼å„²å­˜çš„ width
            widthRangeEl.value = settings.width;
            widthNumberEl.value = settings.width; 
            
            canvas.freeDrawingBrush = settings.brush;
            canvas.freeDrawingBrush.width = settings.width; // æ‡‰ç”¨è©²æ¨¡å¼çš„ç²—ç´°
            canvas.freeDrawingBrush.color = settings.color;Â 
            canvas.freeDrawingBrush.globalCompositeOperation = settings.composite;
            
            if (mode !== 'eraser') {
                colorEl.value = settings.color.substring(0, 7);Â 
            }
            canvas.renderAll();
        } // <--- V38.9 ä¿®æ­£ï¼šç¢ºä¿ setToolMode å‡½æ•¸åœ¨é€™è£¡æ­£ç¢ºçµæŸ


        // --- æ ¸å¿ƒäº‹ä»¶ç›£è½å™¨ç¶å®š (ç¬¬ä¸€æ¬„) ---
        brushModeBtn.addEventListener('click', () => setToolMode('brush'));
        highlighterModeBtn.addEventListener('click', () => setToolMode('highlighter'));
        eraserModeBtn.addEventListener('click', () => setToolMode('eraser'));
        selectModeBtn.addEventListener('click', () => setToolMode('select'));
        panModeBtn.addEventListener('click', () => setToolMode('pan')); 
        
        // ç¹ªåœ–è¨­å®š (é¡è‰²)
        document.getElementById('drawing-color').addEventListener('change', function() {
            if (currentMode === 'brush' || currentMode === 'highlighter') {
                const newColor = this.value;
                let finalColor = newColor;
                if (currentMode === 'highlighter') {
                    finalColor = newColor + '80';
                }
                
                // V38.8 ä¿®æ­£ï¼šæ›´æ–°é¡è‰²è¨­å®š
                brushSettings[currentMode].color = finalColor;
                canvas.freeDrawingBrush.color = finalColor;Â 
            }
        });


        /**
         * æ ¸å¿ƒåŠŸèƒ½ï¼šæ›´æ–°ç­†åˆ·ç²—ç´° (V38.8: å„²å­˜ç²—ç´°åˆ° mode)
         * @param {number} width - æ–°çš„ç­†åˆ·å¯¬åº¦
         * @param {boolean} immediate - æ˜¯å¦ç«‹å³æ›´æ–°
         */
        function updateBrushWidth(width, immediate = false) {
            
            if (currentMode !== 'brush' && currentMode !== 'highlighter' && currentMode !== 'eraser') {
                return;
            }
            
            if (immediate) { // åƒ…ç•¶æ»‘å¡Šæ‹–å‹•ã€æˆ–æ•¸å­—è¼¸å…¥æ¡† blur/Enter æ™‚æ‰åŸ·è¡Œ
                
                // åŸ·è¡Œæœ€å°/æœ€å¤§é™åˆ¶ï¼Œç¢ºä¿æ˜¯æœ‰æ•ˆæ•¸å­—
                width = Math.max(1, Math.min(100, parseInt(width, 10) || 1));
                
                // åŒæ­¥ DOM
                widthRangeEl.value = width;
                widthNumberEl.value = width;

                // V38.8 ä¿®æ­£ï¼šå°‡æ–°çš„å¯¬åº¦å„²å­˜åœ¨ç•¶å‰æ¨¡å¼çš„ brushSettings ä¸­
                brushSettings[currentMode].width = width;
                
                // æ›´æ–°ç•«å¸ƒ
                if (canvas.isDrawingMode) {
                    canvas.freeDrawingBrush.width = width;
                }
            }
        }
        
        /**
         * è™•ç†æ•¸å­—è¼¸å…¥æ¡†çš„è¼¸å…¥å’Œé©—è­‰é‚è¼¯ (V38.7 ä¿®æ­£ï¼šå…è¨±è¼¸å…¥æ™‚åˆªé™¤)
         */
        function handleWidthInput(e) {
            const width = parseInt(e.target.value, 10);

            if (e.type === 'input') {
                // åœ¨è¼¸å…¥éç¨‹ä¸­ï¼ŒåªåŒæ­¥æ»‘å¡Šï¼Œä¸è§¸ç™¼ç­†åˆ·æ›´æ–°
                if (isNaN(width)) {
                    widthRangeEl.value = 1; 
                } else {
                    widthRangeEl.value = Math.min(100, Math.max(0, width)); 
                }
            } else if (e.type === 'blur' || (e.type === 'keydown' && e.key === 'Enter')) {
                // é›¢é–‹æˆ–æŒ‰ Enter æ™‚ï¼ŒåŸ·è¡Œæœ€çµ‚é©—è­‰å’Œç­†åˆ·æ›´æ–°
                updateBrushWidth(e.target.value, true);
            }
        }
        
        // ç­†åˆ·ç²—ç´°äº‹ä»¶ç¶å®š 
        widthRangeEl.addEventListener('input', function() { updateBrushWidth(this.value, true); }); // æ»‘å¡Šï¼šç«‹å³æ›´æ–°
        widthNumberEl.addEventListener('input', handleWidthInput); // æ•¸å­—æ¡†ï¼šè¼¸å…¥æ™‚åƒ…åŒæ­¥æ»‘å¡Š
        widthNumberEl.addEventListener('blur', handleWidthInput); // æ•¸å­—æ¡†ï¼šé›¢é–‹æ™‚é©—è­‰ä¸¦æ›´æ–°
        widthNumberEl.addEventListener('keydown', handleWidthInput); // æ•¸å­—æ¡†ï¼šæŒ‰ Enter æ™‚é©—è­‰ä¸¦æ›´æ–°


        // èª¿è‰²ç›¤é»æ“Š
        document.querySelectorAll('.color-palette-btn').forEach(button => {
            button.addEventListener('click', function() {
                const target = this.dataset.target;
                const newColor = this.dataset.color;
                
                // V38.8 ä¿®æ­£ï¼šåªæ›´æ–°é¡è‰²è¨­å®šä¸¦åˆ‡æ›æ¨¡å¼ï¼Œä¿æŒç²—ç´°ä¸è®Š
                if (target === 'highlighter') {
                    brushSettings.highlighter.color = newColor + '80';
                    setToolMode('highlighter');
                } else {
                    brushSettings.brush.color = newColor;
                    setToolMode('brush');
                }
            });
        });


        // --- ç¬¬äºŒæ¬„åŠŸèƒ½å€å¡Š (V38.6 å®Œæ•´é‚è¼¯) ---

        // 1. èª¿æ•´å°ºå¯¸åŠŸèƒ½
        resizeCanvasBtn.addEventListener('click', () => { 
            const newWidth = parseInt(newWidthEl.value, 10);
            const newHeight = parseInt(newHeightEl.value, 10);

            if (newWidth >= 300 && newHeight >= 300 && !isNaN(newWidth) && !isNaN(newHeight)) {
                canvas.setDimensions({ width: newWidth, height: newHeight });
                canvasContainer.style.width = `${newWidth}px`;
                canvasContainer.style.height = `${newHeight}px`;
                canvas.renderAll();
            } else {
                alert("å¯¬åº¦å’Œé«˜åº¦å¿…é ˆç‚ºå¤§æ–¼ç­‰æ–¼ 300 çš„æ­£æ•´æ•¸ã€‚");
            }
        });


        // 2. å°å…¥åº•åœ–
        bgImageInput.addEventListener('change', function(e) { 
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(f) {
                canvasContainer.style.backgroundImage = `url(${f.target.result})`;
                canvasContainer.style.backgroundSize = 'contain'; 
                canvasContainer.style.backgroundRepeat = 'no-repeat';
                canvasContainer.style.backgroundPosition = 'center';
                canvas.backgroundColor = 'transparent';
                canvas.renderAll();Â 
            };
            reader.readAsDataURL(file);
            e.target.value = null; 
        });

        // 3. æ¸…é™¤åº•åœ– (DOM èƒŒæ™¯)
        clearBgBtn.addEventListener('click', function() { 
            canvasContainer.style.backgroundImage = 'none';
            canvas.backgroundColor = '#ffffff';Â 
            canvas.renderAll();
        });

        // 4. æ¸…é™¤æ‰€æœ‰ç¹ªåœ–/æ–‡å­—
        clearAllDrawingsBtn.addEventListener('click', function() { 
            const objectsToRemove = canvas.getObjects().filter(obj =>Â 
                (obj.type === 'path' || obj.type === 'i-text' || obj.type === 'rect')
            );
            canvas.remove(...objectsToRemove);
            canvas.renderAll();
        });

        // 5. æ’å…¥æ–‡å­—æ–¹å¡Š
        addTextBtn.addEventListener('click', function() {
            setToolMode('select');Â 
            const text = new fabric.IText('é»æ“Šè¼¸å…¥æ–‡å­—', {Â 
                left: 50, top: 50, fontSize: 24, fill: '#333333', editable: true,
                selectable: true,
                evented: true
            });
            canvas.add(text);
            canvas.setActiveObject(text);
            canvas.bringToFront(text);Â 
            text.enterEditing();Â 
            canvas.renderAll();
        });

        // 6. åˆªé™¤é¸å–ç‰©ä»¶
        deleteSelectedBtn.addEventListener('click', function() { 
            const activeObjects = canvas.getActiveObjects();
            if (activeObjects.length > 0) {
                canvas.remove(...activeObjects);
                canvas.discardActiveObject().renderAll();
            }
        });

        // 7. éµç›¤åˆªé™¤
        document.addEventListener('keydown', (e) => { 
            const activeObject = canvas.getActiveObject();
            if ((e.key === 'Delete' || e.key === 'Backspace') && activeObject && !activeObject.isEditing) {
                deleteSelectedBtn.click();
                e.preventDefault();
            }
        });
        
        // 8. å„²å­˜åœ–ç‰‡åŠŸèƒ½æ ¸å¿ƒé‚è¼¯ (V38.6)
        saveImageBtn.addEventListener('click', async function() { 
            saveImageBtn.disabled = true;

            if (typeof html2canvas === 'undefined') {
                alert("éŒ¯èª¤: html2canvas åº«æœªè¼‰å…¥ï¼Œç„¡æ³•åŸ·è¡Œæˆªåœ–åŠŸèƒ½ã€‚è«‹ç¢ºèªå·²å¼•å…¥æ­¤åº«ã€‚");
                saveImageBtn.disabled = false;
                return;
            }

            canvas.discardActiveObject();
            canvas.renderAll();

            try {
                const canvasShot = await html2canvas(canvasContainer, {
                    useCORS: true, 
                    scale: 2,       
                    logging: false  
                });

                const dataURL = canvasShot.toDataURL('image/png');
                const link = document.createElement('a');
                link.href = dataURL;
                link.download = `drawing-${Date.now()}.png`; 
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

            } catch (error) {
                alert("æˆªåœ–å¤±æ•—ã€‚è«‹ç¢ºèªç€è¦½å™¨æ”¯æ´æˆ–åœ–ç‰‡ä¾†æºæ˜¯å¦å…è¨±è·¨åŸŸå­˜å–ã€‚");
                console.error("æˆªåœ–éŒ¯èª¤:", error);
            } finally {
                saveImageBtn.disabled = false;
            }
        });


        // --- ç•«å¸ƒå¹³ç§»é‚è¼¯ ---

        canvas.on('mouse:down', function(opt) {
            const e = opt.e;
            if (currentMode === 'pan' && !opt.target) {
                isPanning = true;
                const pointer = canvas.getPointer(e);
                canvas.lastPosX = pointer.x; 
                canvas.lastPosY = pointer.y; 
                canvas.defaultCursor = 'grabbing';
                e.preventDefault(); 
                return; 
            }
        });

        canvas.on('mouse:move', function(opt) {
            if (!isPanning || currentMode !== 'pan') return; 
            const e = opt.e;
            const pointer = canvas.getPointer(e); 
            const deltaX = pointer.x - canvas.lastPosX;
            const deltaY = pointer.y - canvas.lastPosY;
            canvas.relativePan(new fabric.Point(deltaX, deltaY));
            canvas.lastPosX = pointer.x;
            canvas.lastPosY = pointer.y;
            e.preventDefault(); 
        });

        canvas.on('mouse:up', function(opt) {
            isPanning = false;
            if (currentMode === 'pan') {
                canvas.defaultCursor = 'grab';
            } else if (currentMode === 'eraser') {
                canvas.defaultCursor = 'crosshair';
            } else {
                canvas.defaultCursor = 'default';
            }
        });
        
        // åˆå§‹è¼‰å…¥
        setToolMode('brush');
        canvasContainer.style.backgroundColor = '#ffffff';Â 
        newWidthEl.value = initialWidth;
        newHeightEl.value = initialHeight;
        canvas.renderAll();
    });
</script>

</body>
</html>
