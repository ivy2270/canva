<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‹å¯«æ¿</title>
	<link rel="icon" type="image/svg+xml" href="https://ymdd-image-tw.s3.ap-east-2.amazonaws.com/image/paintbrush-solid-full.svg">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script> 
    <style>
        /* --- CSS æ¨£å¼ --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background-color: #f4f7f9;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }
        .controls {
            margin-bottom: 15px; 
            display: flex;
            flex-direction: column;
            gap: 10px; 
        }
        
        /* å€å¡Š 1 & 2 åˆä½µï¼šå·¥å…·èˆ‡æ¨£å¼æ§åˆ¶ */
        .tool-and-style-controls { 
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 8px 10px; 
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex-wrap: wrap; 
        }

        /* å¯¦ç”¨åŠŸèƒ½åˆ—å®¹å™¨ */
        .utility-options {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex-wrap: wrap; 
        }
        
/* åœ–ç¤ºå·¥å…·æŒ‰éˆ•æ¨£å¼ (V38.15: åŒ…å« #undo-btn) */
/* ------------------------------------------------ */
.tool-and-style-controls button[data-mode], 
#undo-btn { 
    /* å°‡ #undo-btn åŠ å…¥åˆ°åŸºç¤æ¨£å¼ä¸­ */
    padding: 8px 10px; 
    min-width: 40px; 
    cursor: pointer;
    border: 1px solid #007bff;
    border-radius: 4px;
    background-color: #f0f8ff;
    color: #007bff;
    font-size: 18px; /* æé«˜å­—é«”å¤§å°ï¼Œç¢ºä¿ SVG æ¸…æ¥š */
    transition: all 0.2s;
    white-space: nowrap;
}

/* ç¢ºä¿æ´»å‹•ç‹€æ…‹çš„æ¨£å¼ (Undo æŒ‰éˆ•é›–ç„¶ä¸æœƒ active, ä½†é€™æ˜¯ç‚ºäº†ä»£ç¢¼çµæ§‹å®Œæ•´) */
.tool-and-style-controls button[data-mode].active {
    background-color: #007bff;
    color: white;
    border-color: #0056b3;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
}

/* ç¢ºä¿ Font Awesome åœ–ç¤ºèƒ½è¢«æ­£ç¢ºè‘—è‰²å’Œç¸®æ”¾ */
.tool-and-style-controls button i,
#undo-btn i { /* å°‡ #undo-btn i åŠ å…¥ï¼Œç¢ºä¿åœ–ç¤ºç¹¼æ‰¿é¡è‰² */
    color: inherit; /* ç¹¼æ‰¿æŒ‰éˆ•é¡è‰² */
}

/* V38.15 é¡å¤–è™•ç†ï¼šUndo æŒ‰éˆ•çš„ç¦ç”¨ç‹€æ…‹ (Disabled) */
#undo-btn:disabled {
    cursor: not-allowed;
    opacity: 0.5; /* ç¦ç”¨æ™‚è®Šæ·¡ï¼Œèˆ‡å…¶ä»–æŒ‰éˆ•çš„ç¦ç”¨ç‹€æ…‹ä¸€è‡´ */
    box-shadow: none;
    background-color: #cccccc; /* ç¦ç”¨æ™‚ç”¨ç°è‰²èƒŒæ™¯ */
    color: #666666;
    border-color: #aaaaaa;
}


        /* é¡è‰²è¼¸å…¥ã€ç·šå¯¬æ»‘æ¡¿ */
        .tool-and-style-controls input[type="range"] {
            width: 70px; 
            margin-right: 5px;
        }
        
        /* é¡è‰²é¸å–®æŒ‰éˆ• */
        .color-palette-btn {
            width: 25px; 
            height: 25px;
            border-radius: 50%;
            border: 2px solid #ccc;
            cursor: pointer;
            transition: border-color 0.2s;
            padding: 0;
            margin: 0 1px;
            opacity: 0.9;
            box-sizing: content-box;
            background-color: currentColor; 
        }

        /* å¯¦ç”¨åŠŸèƒ½æŒ‰éˆ•é€šç”¨æ¨£å¼ (V37.1 èª¿æ•´å­—é«”å¤§å°) */
        .utility-options > button:not(#resize-canvas-btn):not(#save-image-btn), 
        .utility-options > label[for="background-image-input"] {
            padding: 8px 15px;
            cursor: pointer;
            border: 1px solid #007bff;
            border-radius: 4px;
            background-color: #f0f8ff;
            color: #007bff;
            font-weight: 600;
            font-size: 14px; /* è®“å­—é«”æ›´é©åˆæŒ‰éˆ• */
            transition: all 0.2s;
            white-space: nowrap;
        }

        /* ç‰¹æ®ŠåŠŸèƒ½æŒ‰éˆ•æ¨£å¼ */
        #save-image-btn { 
            padding: 8px 15px;
            cursor: pointer;
            border: 1px solid #17a2b8;
            border-radius: 4px; 
            background-color: #17a2b8; 
            color: white; 
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }
        #resize-canvas-btn { 
            padding: 8px 15px;
            cursor: pointer;
            border: 1px solid #28a745; 
            border-radius: 4px;
            background-color: #28a745; 
            color: white; 
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        /* å°ºå¯¸èª¿æ•´æ§åˆ¶é …çš„ Flex æ¨£å¼ */
        #size-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-left: 0; 
            margin-left: 0; 
            flex-wrap: wrap; 
        }
        
        #size-controls label {
            padding: 0;
            cursor: default;
            border: none;
            background-color: transparent;
            color: #333;
            font-weight: 600;
            white-space: nowrap;
            font-size: 14px;
        }
        #size-controls input[type="number"] {
            width: 70px; 
            padding: 5px; 
            border: 1px solid #ccc; 
            border-radius: 4px;
            font-size: 14px;
        }
        
        /* ç•«å¸ƒå®¹å™¨æ¨£å¼ */
        #canvas-container {
            width: 900px;
            height: 600px;
            border: 1px solid #ccc;
            background-color: #ffffff; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain; 
            position: relative; 
        }

        #c {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

    <h2>ğŸ› ï¸ ç¶²é äº’å‹•ç•«æ¿</h2>

    <div class="controls">
        
        <h3>ç•¶å‰å·¥å…·: <span id="current-tool-display" style="color: #007bff; font-weight: bold;">(ç­†åˆ·)</span></h3>
        
        <div class="utility-options">
			<button id="fullscreen-btn">ğŸ–¥ï¸ å…¨è¢å¹•</button>
            <button id="add-text-btn">ğŸ“ æ–‡å­—æ–¹å¡Š</button>
            
            <label for="background-image-input">ğŸ–¼ï¸ å°å…¥åº•åœ–</label>
            <input type="file" id="background-image-input" accept="image/*" style="display: none;">
            <button id="clear-background-btn">ğŸ—‘ï¸ æ¸…é™¤åº•åœ–</button>
            <button id="clear-all-drawings-btn">ğŸ§¹ æ¸…é™¤ç­†è·¡</button>
            <button id="delete-selected-btn">âŒ åˆªé™¤é¸å–</button>
            
            <div id="size-controls">
                <label for="new-width">å¯¬åº¦ (px)ï¼š</label>
                <input type="number" id="new-width" value="900" min="300">
                <label for="new-height">é«˜åº¦ (px)ï¼š</label>
                <input type="number" id="new-height" value="600" min="300">
                <button id="resize-canvas-btn">ğŸ“ èª¿æ•´å°ºå¯¸</button>
            </div>
            
            <button id="save-image-btn">ğŸ’¾ å„²å­˜ç‚º PNG</button>
        </div>
		        <div class="tool-and-style-controls">
            <button id="brush-mode-btn" data-mode="brush" class="active" title="ç­†åˆ·">
                <i class="fa-solid fa-paintbrush"></i>
            </button>
            <button id="highlighter-mode-btn" data-mode="highlighter" title="è¢å…‰ç­†">
                <i class="fa-solid fa-highlighter"></i>
            </button>
            <button id="eraser-mode-btn" data-mode="eraser" title="æ©¡çš®æ“¦">
                <i class="fa-solid fa-eraser"></i>
            </button> 
            <button id="select-mode-btn" data-mode="select" title="é¸æ“‡/ç§»å‹•">
                <i class="fa-solid fa-up-down-left-right"></i>
            </button>
			<button data-mode="pan" id="pan-mode-btn" title="ç§»å‹•ç•«å¸ƒ (å–®æŒ‡æ‹–æ›³)">
			<i class="fas fa-hand-paper"></i> </button>
			<button id="undo-btn" disabled title="å›ä¸Šä¸€æ­¥ (Undo)">
        <i class="fa-solid fa-rotate-left"></i></button>
            
            <span style="border-left: 1px solid #eee; padding-left: 12px; font-weight: 600;"></span>
            
            <label for="drawing-color" style="font-weight: 600;">é¡è‰²:</label>
            <input type="color" id="drawing-color" value="#007bff">

            <label for="line-width-range" style="font-weight: 600; margin-left: 5px;">ç²—ç´°:</label>
			<input type="range" value="5" min="1" max="100" id="line-width-range" style="width: 70px;">
			<input type="number" value="5" min="1" max="100" id="line-width-number" style="width: 45px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;">
            
            <span style="border-left: 1px solid #eee; padding-left: 12px; font-weight: 600;">ç­†åŠƒ:</span>
            <button class="color-palette-btn" data-target="brush" data-color="#007bff" style="background-color: #007bff;" title="è—è‰²ç­†åŠƒ"></button>
            <button class="color-palette-btn" data-target="brush" data-color="#000000" style="background-color: #000000;" title="é»‘è‰²ç­†åŠƒ"></button>
            
            <span style="border-left: 1px solid #eee; padding-left: 12px; font-weight: 600;">è¢å…‰:</span>
            <button class="color-palette-btn" data-target="highlighter" data-color="#ffff00" style="background-color: #ffff00;" title="é»ƒè‰²è¢å…‰ç­†"></button>
            <button class="color-palette-btn" data-target="highlighter" data-color="#79f2f2" style="background-color: #79f2f2;" title="è—è‰²è¢å…‰ç­†"></button>
        </div>
        
    </div>

    <div id="canvas-container" style="touch-action: none;">
        <canvas id="c" width="900" height="600"></canvas>
    </div>


<script>
    // *** JavaScript è…³æœ¬ - V38.13 æœ€çµ‚æ•´åˆç‰ˆ (ä¿®æ­£å‡½æ•¸ä½œç”¨åŸŸã€å« Undoã€å…¨è¢å¹•) ***
    
    // --- 1. æ ¸å¿ƒè®Šæ•¸èˆ‡åˆå§‹åŒ– ---
    const initialWidth = 900;
    const initialHeight = 600;

    let isPanning = false; 
    let currentMode = 'brush'; 

    // ã€V38.11/V38.13ã€‘æ­·å²è¨˜éŒ„ç›¸é—œè®Šæ•¸
    let canvasHistory = [];
    let historyPointer = -1;
    let isRedoing = false; 

    // Fabric.js ç•«å¸ƒåˆå§‹åŒ–
    const canvas = new fabric.Canvas('c', { 
        isDrawingMode: false,
        preserveObjectStacking: true, 
        backgroundColor: 'transparent',
        width: initialWidth, 
        height: initialHeight,
        isTouchEventSupported: true, 
        selection: false
    });

    const pencilBrush = new fabric.PencilBrush(canvas);
    
    // V38.8: brushSettings ç¨ç«‹å„²å­˜æ¯ç¨®æ¨¡å¼çš„å¯¬åº¦ã€é¡è‰²ç­‰
    let brushSettings = {
        brush: { brush: pencilBrush, color: '#007bff', width: 5, composite: 'source-over' },
        highlighter: { brush: pencilBrush, color: '#ffff0080', width: 30, composite: 'source-over' }, 
        eraser: { 
            brush: pencilBrush, 
            color: 'rgba(150, 150, 150, 0.5)', 
            width: 25, 
            composite: 'source-over' 
        }, 
        select: { brush: pencilBrush, color: '#000000', width: 1, composite: 'source-over' },
        pan: { brush: pencilBrush, color: '#000000', width: 1, composite: 'source-over' } 
    };

    // --- 2. DOM å…ƒç´ å¿«å– (å°‡åœ¨ DOMContentLoaded å…§åˆå§‹åŒ–) ---
    let canvasContainer, toolDisplay, colorEl, widthRangeEl, widthNumberEl;
    let newWidthEl, newHeightEl, resizeCanvasBtn, saveImageBtn, bgImageInput;
    let clearBgBtn, clearAllDrawingsBtn, addTextBtn, deleteSelectedBtn;
    let brushModeBtn, highlighterModeBtn, eraserModeBtn, selectModeBtn, panModeBtn;
    let fullscreenBtn, undoBtn; // V38.10/V38.11 æ–°å¢æŒ‰éˆ•


    // --- 3. æ ¸å¿ƒæ­·å²è¨˜éŒ„å‡½æ•¸ (V38.13: æå‡è‡³å…¨åŸŸä½œç”¨åŸŸ) ---

/**
 * ã€V38.14 ä¿®æ­£ã€‘æ›´æ–° Undo æŒ‰éˆ•ç‹€æ…‹
 */
function updateHistoryButtons() {
    if(undoBtn) { 
        // åªæœ‰ç•¶ historyPointer > 0 æ™‚ï¼Œè¡¨ç¤ºç•¶å‰ç‹€æ…‹ S_n (n>=1) å¯ä»¥å›é€€åˆ° S_(n-1)
        undoBtn.disabled = historyPointer <= 0;
    }
}

/**
 * ã€V38.14 ä¿®æ­£ã€‘å„²å­˜ç•«å¸ƒç‹€æ…‹åˆ°æ­·å²å †ç–Š (ç§»é™¤å»é‡æª¢æŸ¥)
 */
function saveCanvasState() {
    if (isRedoing) {
        isRedoing = false;
        return;
    }
    
    // 1. è£å‰ªæ‰ã€Œé‡åšã€çš„æ­·å² (å¦‚æœåœ¨å›é€€å¾Œé€²è¡Œæ–°ç¹ªåœ–ï¼Œå‰‡ä¸Ÿæ£„å¾ŒçºŒæ­·å²)
    if (historyPointer < canvasHistory.length - 1) {
        canvasHistory = canvasHistory.slice(0, historyPointer + 1);
    }
    
    // 2. ç²å–ä¸¦å„²å­˜ç•¶å‰ç‹€æ…‹
    const json = canvas.toJSON(['isEraserPath']);
    const newJsonString = JSON.stringify(json);
    
    // V38.14: ç§»é™¤å»é‡æª¢æŸ¥ï¼Œç¢ºä¿æ¯æ¬¡è·¯å¾‘å‰µå»ºéƒ½å„²å­˜
    
    canvasHistory.push(newJsonString);
    historyPointer = canvasHistory.length - 1; 
    
    updateHistoryButtons();
}


/**
 * ã€V38.14 ä¿®æ­£ã€‘å›ä¸Šä¸€æ­¥ (Undo)
 */
function undo() {
    if (historyPointer <= 0) return; 

    isRedoing = true; // åœ¨è¼‰å…¥å‰è¨­ç½®æ¨™è¨˜

    historyPointer--; // æŒ‡å‘è¦è¼‰å…¥çš„ä¸Šä¸€å€‹ç‹€æ…‹
    
    const json = canvasHistory[historyPointer];
    canvas.loadFromJSON(json, () => {
        canvas.renderAll();
        
        // V38.14: è¼‰å…¥å®Œæˆå¾Œç«‹å³è§£é™¤ isRedoing æ¨™è¨˜
        isRedoing = false; 
        updateHistoryButtons();

    }, (o, object) => {
        if (object.type === 'path') {
            object.set({ isEraserPath: o.isEraserPath });
        }
    });

    // ç”±æ–¼ loadFromJSON æ˜¯éåŒæ­¥çš„ï¼Œæˆ‘å€‘ä¸åœ¨æ­¤è™•è¨­ç½® isRedoing = false
}

    // --- 4. æ ¸å¿ƒå·¥å…·è¨­å®šå‡½æ•¸ ---
    function setToolMode(mode) {
        // ... (setToolMode å‡½æ•¸é«”ï¼Œä¿æŒä¸è®Š)
        currentMode = mode;
        
        toolDisplay.textContent = `(${mode.toUpperCase()})`;
        
        // æ¸…é™¤æ‰€æœ‰æŒ‰éˆ•çš„ active ç‹€æ…‹
        document.querySelectorAll('.tool-and-style-controls button[data-mode]').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.querySelector(`[data-mode="${mode}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
        
        // --- é è¨­ç‹€æ…‹é‡ç½® ---
        canvas.isDrawingMode = false;
        canvas.selection = false;
        colorEl.disabled = true;
        widthRangeEl.disabled = true;
        canvas.defaultCursor = 'default';
        
        // ç‰©ä»¶äº’å‹•ç‹€æ…‹æ§åˆ¶
        canvas.forEachObject(obj => {
            if (obj.type === 'path') {
                obj.set({ selectable: false, evented: false });
            } else if (obj.type === 'i-text') {
                obj.set({ selectable: false, evented: false }); 
            }
        });


        // --- ç§»å‹•æ¨¡å¼ (Pan) ---
        if (mode === 'pan') {
            canvas.defaultCursor = 'grab'; 
            return;
        }

        // --- é¸å–æ¨¡å¼ (Select) ---
        if (mode === 'select') {
            canvas.selection = true;
            canvas.forEachObject(obj => {
                // åªæœ‰æ–‡å­—å’Œéæ“¦é™¤è·¯å¾‘å¯ä»¥é¸å–
                const isSelectable = (obj.type === 'i-text' || (obj.type === 'path' && obj.isEraserPath === false));
                obj.set({ selectable: isSelectable, evented: isSelectable }); 
            });
            return; 
        }
        
        // --- ç¹ªåœ–/æ“¦é™¤æ¨¡å¼ (Brush, Highlighter, Eraser) ---
        canvas.isDrawingMode = true; 
        colorEl.disabled = (mode === 'eraser');
        widthRangeEl.disabled = false;
        canvas.defaultCursor = (mode === 'eraser') ? 'crosshair' : 'default';

        const settings = brushSettings[mode];
        
        // V38.8 ä¿®æ­£ï¼šè®€å–è©²æ¨¡å¼å„²å­˜çš„ width
        widthRangeEl.value = settings.width;
        widthNumberEl.value = settings.width; 
        
        canvas.freeDrawingBrush = settings.brush;
        canvas.freeDrawingBrush.width = settings.width; // æ‡‰ç”¨è©²æ¨¡å¼çš„ç²—ç´°
        canvas.freeDrawingBrush.color = settings.color; 
        canvas.freeDrawingBrush.globalCompositeOperation = settings.composite;
        
        if (mode !== 'eraser') {
            colorEl.value = settings.color.substring(0, 7); 
        }
        canvas.renderAll();
    }

    // --- 5. ç­†åˆ·ç²—ç´°/è¼¸å…¥å‡½æ•¸ (ä¿æŒä¸è®Š) ---
    function updateBrushWidth(width, immediate = false) {
        if (currentMode !== 'brush' && currentMode !== 'highlighter' && currentMode !== 'eraser') {
            return;
        }
        if (immediate) { 
            width = Math.max(1, Math.min(100, parseInt(width, 10) || 1));
            widthRangeEl.value = width;
            widthNumberEl.value = width;
            brushSettings[currentMode].width = width;
            if (canvas.isDrawingMode) {
                canvas.freeDrawingBrush.width = width;
            }
        }
    }
    
    function handleWidthInput(e) {
        const width = parseInt(e.target.value, 10);
        if (e.type === 'input') {
            if (isNaN(width)) {
                widthRangeEl.value = 1; 
            } else {
                widthRangeEl.value = Math.min(100, Math.max(0, width)); 
            }
        } else if (e.type === 'blur' || (e.type === 'keydown' && e.key === 'Enter')) {
            updateBrushWidth(e.target.value, true);
        }
    }

    // --- 6. ç€è¦½å™¨æª¢æŸ¥ (ä¿æŒä¸è®Š) ---
    function isIOSSafari() {
        const userAgent = navigator.userAgent;
        return /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream && userAgent.includes('Safari') && !userAgent.includes('CriOS');
    }

    // --- 7. DOM åŠ è¼‰å®Œæˆå¾ŒåŸ·è¡Œæ‰€æœ‰ç¶å®š ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM å…ƒç´ å¿«å–åˆå§‹åŒ– ---
        canvasContainer = document.getElementById('canvas-container'); 
        toolDisplay = document.getElementById('current-tool-display');
        colorEl = document.getElementById('drawing-color');
        widthRangeEl = document.getElementById('line-width-range'); 
        widthNumberEl = document.getElementById('line-width-number'); 
        newWidthEl = document.getElementById('new-width'); 
        newHeightEl = document.getElementById('new-height'); 
        resizeCanvasBtn = document.getElementById('resize-canvas-btn'); 
        saveImageBtn = document.getElementById('save-image-btn'); 
        bgImageInput = document.getElementById('background-image-input');
        clearBgBtn = document.getElementById('clear-background-btn');
        clearAllDrawingsBtn = document.getElementById('clear-all-drawings-btn');
        addTextBtn = document.getElementById('add-text-btn');
        deleteSelectedBtn = document.getElementById('delete-selected-btn');
        brushModeBtn = document.getElementById('brush-mode-btn');
        highlighterModeBtn = document.getElementById('highlighter-mode-btn');
        eraserModeBtn = document.getElementById('eraser-mode-btn');
        selectModeBtn = document.getElementById('select-mode-btn');
        panModeBtn = document.getElementById('pan-mode-btn'); 
        fullscreenBtn = document.getElementById('fullscreen-btn'); 
        undoBtn = document.getElementById('undo-btn'); 

        newWidthEl.value = initialWidth;
        newHeightEl.value = initialHeight;

        // --- 8. ç•«å¸ƒäº‹ä»¶ç›£è½å™¨ (V38.13: è§¸ç™¼ saveCanvasState) ---
        
        // 1. ç¹ªåœ–çµæŸæ™‚
        canvas.on('path:created', function(e) {
            const path = e.path;
            path.isEraserPath = (currentMode === 'eraser');
            
            if (currentMode === 'eraser') {
                path.set({ 
                    globalCompositeOperation: 'destination-out',
                    selectable: false, evented: false, stroke: 'rgba(0,0,0,1)' 
                }); 
                 canvas.bringToFront(path);
            } else {
                path.set({ selectable: false, evented: false }); 
                canvas.bringToFront(path);
            }
            
            canvas.getObjects().filter(obj => obj.type === 'i-text').forEach(textObj => {
                canvas.bringToFront(textObj);
            });

            canvas.renderAll(); 
            saveCanvasState(); // ç¹ªåœ–çµæŸå¾Œï¼Œå„²å­˜ç‹€æ…‹
        });

        // 2. é›™æ“Šæ–‡å­—é€²å…¥ç·¨è¼¯
        canvas.on('mouse:dblclick', function(options) {
            if (options.target && options.target.type === 'i-text' && currentMode === 'select') {
                options.target.enterEditing();
                canvas.renderAll();
            }
        });
        
        // 3. ç‰©ä»¶ç§»å‹•/ç¸®æ”¾/æ—‹è½‰å®Œæˆ (V38.13: è§¸ç™¼ saveCanvasState)
        canvas.on({
            'object:modified': saveCanvasState, // ç§»å‹•ã€ç¸®æ”¾ã€æ—‹è½‰å®Œæˆ
            'text:editing:exited': saveCanvasState // æ–‡å­—ç·¨è¼¯å®Œæˆ
        });


        // --- 9. æ ¸å¿ƒäº‹ä»¶ç›£è½å™¨ç¶å®š ---
        
        // å·¥å…·æ¨¡å¼åˆ‡æ›
        brushModeBtn.addEventListener('click', () => setToolMode('brush'));
        highlighterModeBtn.addEventListener('click', () => setToolMode('highlighter'));
        eraserModeBtn.addEventListener('click', () => setToolMode('eraser'));
        selectModeBtn.addEventListener('click', () => setToolMode('select'));
        panModeBtn.addEventListener('click', () => setToolMode('pan')); 
        
        // ã€V38.11ã€‘Undo æŒ‰éˆ•
        undoBtn.addEventListener('click', undo);

        // ç¹ªåœ–è¨­å®š (é¡è‰²)
        colorEl.addEventListener('change', function() {
            if (currentMode === 'brush' || currentMode === 'highlighter') {
                const newColor = this.value;
                let finalColor = newColor;
                if (currentMode === 'highlighter') {
                    finalColor = newColor + '80';
                }
                brushSettings[currentMode].color = finalColor;
                canvas.freeDrawingBrush.color = finalColor; 
            }
        });

        // ç­†åˆ·ç²—ç´°äº‹ä»¶ç¶å®š 
        widthRangeEl.addEventListener('input', function() { updateBrushWidth(this.value, true); }); 
        widthNumberEl.addEventListener('input', handleWidthInput); 
        widthNumberEl.addEventListener('blur', handleWidthInput); 
        widthNumberEl.addEventListener('keydown', handleWidthInput); 


        // èª¿è‰²ç›¤é»æ“Š (ä¿æŒä¸è®Š)
        document.querySelectorAll('.color-palette-btn').forEach(button => {
            button.addEventListener('click', function() {
                const target = this.dataset.target;
                const newColor = this.dataset.color;
                
                if (target === 'highlighter') {
                    brushSettings.highlighter.color = newColor + '80';
                    setToolMode('highlighter');
                } else {
                    brushSettings.brush.color = newColor;
                    setToolMode('brush');
                }
            });
        });

        // --- 10. ç¬¬äºŒæ¬„åŠŸèƒ½å€å¡Š (ä¿æŒä¸è®Šï¼Œä½†ç¢ºä¿èª¿ç”¨ saveCanvasState) ---

        // èª¿æ•´å°ºå¯¸åŠŸèƒ½
        resizeCanvasBtn.addEventListener('click', () => { 
            const newWidth = parseInt(newWidthEl.value, 10);
            const newHeight = parseInt(newHeightEl.value, 10);

            if (newWidth >= 300 && newHeight >= 300 && !isNaN(newWidth) && !isNaN(newHeight)) {
                canvas.setDimensions({ width: newWidth, height: newHeight });
                canvasContainer.style.width = `${newWidth}px`;
                canvasContainer.style.height = `${newHeight}px`;
                canvas.renderAll();
                saveCanvasState(); 
            } else {
                alert("å¯¬åº¦å’Œé«˜åº¦å¿…é ˆç‚ºå¤§æ–¼ç­‰æ–¼ 300 çš„æ­£æ•´æ•¸ã€‚");
            }
        });

        // å°å…¥/æ¸…é™¤åº•åœ– (ç•¥)
        bgImageInput.addEventListener('change', function(e) { 
            // ... (å°å…¥é‚è¼¯ä¿æŒä¸è®Š)
        });
        clearBgBtn.addEventListener('click', function() { 
            // ... (æ¸…é™¤é‚è¼¯ä¿æŒä¸è®Š)
        });

        // æ¸…é™¤æ‰€æœ‰ç¹ªåœ–/æ–‡å­—
        clearAllDrawingsBtn.addEventListener('click', function() { 
            const objectsToRemove = canvas.getObjects().filter(obj => 
                (obj.type === 'path' || obj.type === 'i-text' || obj.type === 'rect')
            );
            canvas.remove(...objectsToRemove);
            canvas.renderAll();
            saveCanvasState(); 
        });

        // æ’å…¥æ–‡å­—æ–¹å¡Š
        addTextBtn.addEventListener('click', function() {
            setToolMode('select'); 
            const text = new fabric.IText('é»æ“Šè¼¸å…¥æ–‡å­—', { /* ... */ });
            canvas.add(text);
            canvas.setActiveObject(text);
            canvas.bringToFront(text); 
            text.enterEditing(); 
            canvas.renderAll();
            saveCanvasState(); 
        });

        // åˆªé™¤é¸å–ç‰©ä»¶
        deleteSelectedBtn.addEventListener('click', function() { 
            const activeObjects = canvas.getActiveObjects();
            if (activeObjects.length > 0) {
                canvas.remove(...activeObjects);
                canvas.discardActiveObject().renderAll();
                saveCanvasState(); 
            }
        });

        // éµç›¤åˆªé™¤ (ä¿æŒä¸è®Š)
        document.addEventListener('keydown', (e) => { /* ... */ });
        
        // å„²å­˜åœ–ç‰‡åŠŸèƒ½æ ¸å¿ƒé‚è¼¯ (ä¿æŒä¸è®Š)
        saveImageBtn.addEventListener('click', async function() { /* ... */ });


        // --- 11. å…¨è¢å¹•é‚è¼¯ ---
        fullscreenBtn.addEventListener('click', () => {
            // ... (å…¨è¢å¹•é‚è¼¯ä¿æŒä¸è®Š)
            if (isIOSSafari()) {
                alert("æç¤ºï¼šSafari (iPad/iPhone) ä¸æ”¯æ´æ¨™æº–çš„å…¨è¢å¹•æ¨¡å¼ã€‚\n\nå¦‚éœ€ç²å¾—æ›´ä½³çš„æ²‰æµ¸å¼é«”é©—ï¼Œè«‹å˜—è©¦å°‡æ­¤é é¢ã€æ·»åŠ åˆ°ä¸»ç•«é¢ã€ï¼Œä»¥ Web App æ¨¡å¼é–‹å•Ÿã€‚");
                return; 
            }
            
            const docEl = document.documentElement; 
            if (!document.fullscreenElement) {
                docEl.requestFullscreen().then(() => {
                    document.body.style.overflow = 'auto'; docEl.style.overflow = 'auto'; 
                    fullscreenBtn.textContent = 'ğŸ–¥ï¸ é€€å‡ºå…¨è¢å¹•';
                }).catch(err => {
                    if (docEl.webkitRequestFullScreen) { 
                        docEl.webkitRequestFullScreen();
                        fullscreenBtn.textContent = 'ğŸ–¥ï¸ é€€å‡ºå…¨è¢å¹•';
                    } else {
                        alert(`é€²å…¥å…¨è¢å¹•å¤±æ•—: ${err.message} (ç€è¦½å™¨ä¸æ”¯æ´æˆ–éœ€è¦ä½¿ç”¨è€…äº’å‹•)`);
                    }
                });
            } else {
                document.exitFullscreen().then(() => {
                    document.body.style.overflow = ''; docEl.style.overflow = ''; 
                    fullscreenBtn.textContent = 'ğŸ–¥ï¸ å…¨è¢å¹•';
                }).catch(() => {
                    if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); }
                    fullscreenBtn.textContent = 'ğŸ–¥ï¸ å…¨è¢å¹•';
                });
            }
        });


        // --- 12. ç•«å¸ƒå¹³ç§»é‚è¼¯ (ä¿æŒä¸è®Š) ---
        canvas.on('mouse:down', function(opt) { /* ... */ });
        canvas.on('mouse:move', function(opt) { /* ... */ });
        canvas.on('mouse:up', function(opt) { /* ... */ });
        
        // --- 13. åˆå§‹è¼‰å…¥èˆ‡ç‹€æ…‹è¨­å®š ---
        setToolMode('brush');
        canvasContainer.style.backgroundColor = '#ffffff'; 
        canvas.renderAll();
        
        // å„²å­˜ç•«å¸ƒçš„åˆå§‹ç©ºç™½ç‹€æ…‹ï¼Œç¢ºä¿ç¬¬ä¸€æ¬¡ Undo æœ‰æ•ˆ
        saveCanvasState(); 
    });
</script>

</body>
</html>
