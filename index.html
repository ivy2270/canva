<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼·åŒ–ç‰ˆç•«æ¿ï¼šå„²å­˜ä¿®å¾©ç©©å®šç‰ˆ V32.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script> 
    <style>
        /* --- CSS æ¨£å¼ (ä¿æŒV31.0ä¸€è‡´) --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background-color: #f4f7f9;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .tool-selection, .drawing-options, .utility-options, .color-palettes {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex-wrap: wrap;
        }
        .tool-selection button, .utility-options button, .utility-options label {
            padding: 8px 15px;
            cursor: pointer;
            border: 1px solid #007bff;
            border-radius: 4px;
            background-color: #f0f8ff;
            color: #007bff;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .utility-options #save-image-btn { 
            background-color: #17a2b8; 
            color: white; 
            border-color: #17a2b8;
        }
        .tool-selection button.active {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }
        .utility-options label[for="background-image-input"] {
            background-color: #eafaea;
            border-color: #28a745;
            color: #28a745;
        }
        .color-palette-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #ccc;
            cursor: pointer;
            transition: border-color 0.2s;
            padding: 0;
            margin: 0 2px;
            opacity: 0.8;
            box-sizing: content-box;
            background-color: currentColor; 
        }

        /* ç•«å¸ƒå®¹å™¨æ¨£å¼ */
        #canvas-container {
            width: 900px;
            height: 600px;
            border: 1px solid #ccc;
            background-color: #ffffff; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain; 
            position: relative; 
        }

        #c {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

    <h2>ğŸ› ï¸ ç¶²é äº’å‹•ç•«æ¿</h2>

    <div class="controls">
        
        <h3>ç•¶å‰å·¥å…·: <span id="current-tool-display" style="color: #007bff; font-weight: bold;">(ç­†åˆ·)</span></h3>
        <div class="tool-selection" id="tool-bar">
            <button id="brush-mode-btn" data-mode="brush" class="active">âœï¸ ç­†åˆ·</button>
            <button id="highlighter-mode-btn" data-mode="highlighter">ğŸ–ï¸ è¢å…‰ç­†</button>
            <button id="eraser-mode-btn" data-mode="eraser">ğŸ—‘ï¸ æ©¡çš®æ“¦</button>
            <button id="select-mode-btn" data-mode="select">ğŸ–±ï¸ é¸æ“‡/ç§»å‹•</button>
        </div>

        <div class="drawing-options">
            <label for="drawing-color">é¡è‰²ï¼š</label>
            <input type="color" id="drawing-color" value="#007bff">

            <label for="line-width">ç²—ç´° (px)ï¼š</label>
            <input type="range" value="5" min="1" max="100" id="line-width">
            <span id="line-width-display">5</span>
        </div>

        <div class="color-palettes">
            <span style="font-weight: 600;">ç­†åŠƒ:</span>
            <button class="color-palette-btn" data-target="brush" data-color="#007bff" style="background-color: #007bff;"></button>
            <button class="color-palette-btn" data-target="brush" data-color="#dc3545" style="background-color: #dc3545;"></button>
            <button class="color-palette-btn" data-target="brush" data-color="#28a745" style="background-color: #28a745;"></button>
            <button class="color-palette-btn" data-target="brush" data-color="#000000" style="background-color: #000000;"></button>
            <span style="border-left: 1px solid #eee; padding-left: 12px;"></span>
            <span style="font-weight: 600;">è¢å…‰ç­†:</span>
            <button class="color-palette-btn" data-target="highlighter" data-color="#ffff00" style="background-color: #ffff00;"></button>
            <button class="color-palette-btn" data-target="highlighter" data-color="#79f2f2" style="background-color: #79f2f2;"></button>
            <button class="color-palette-btn" data-target="highlighter" data-color="#ff99e6" style="background-color: #ff99e6;"></button>
        </div>

        <div class="utility-options">
            <button id="add-text-btn">ğŸ“ æ’å…¥æ–‡å­—æ–¹å¡Š</button>
            
            <label for="background-image-input">ğŸ–¼ï¸ å°å…¥åœ–ç‰‡ä½œåº•åœ–</label>
            <input type="file" id="background-image-input" accept="image/*" style="display: none;">
            <button id="clear-background-btn">æ¸…é™¤åº•åœ–</button>
            <button id="clear-all-drawings-btn">ğŸ§¹ æ¸…é™¤æ‰€æœ‰ç­†è·¡</button>
            <button id="delete-selected-btn">âŒ åˆªé™¤é¸å–ç‰©ä»¶</button>
            <button id="save-image-btn">ğŸ’¾ å„²å­˜ç‚º PNG</button>
        </div>
        
    </div>

    <div id="canvas-container">
        <canvas id="c" width="900" height="600"></canvas>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- æ ¸å¿ƒè®Šæ•¸èˆ‡åˆå§‹åŒ– ---
            const canvas = new fabric.Canvas('c', { 
                isDrawingMode: false,
                preserveObjectStacking: true, 
                backgroundColor: 'transparent' 
            });

            const pencilBrush = new fabric.PencilBrush(canvas);
            let brushSettings = {
                brush: { brush: pencilBrush, color: '#007bff', width: 5, composite: 'source-over' },
                highlighter: { brush: pencilBrush, color: '#ffff0080', width: 30, composite: 'source-over' }, 
                eraser: { 
                    brush: pencilBrush, 
                    color: 'rgba(150, 150, 150, 0.5)', 
                    width: 25, 
                    composite: 'source-over' 
                }, 
                select: { brush: pencilBrush, color: '#000000', width: 1, composite: 'source-over' }
            };
            let currentMode = 'brush'; 

            // --- DOM å…ƒç´ å¿«å– (V31.0 é‚è¼¯) ---
            const canvasContainer = document.getElementById('canvas-container'); 
            const toolDisplay = document.getElementById('current-tool-display');
            const colorEl = document.getElementById('drawing-color');
            const widthRangeEl = document.getElementById('line-width');
            const widthDisplayEl = document.getElementById('line-width-display');
            const saveImageBtn = document.getElementById('save-image-btn'); 
            
            const toolButtons = {
                brush: document.getElementById('brush-mode-btn'),
                highlighter: document.getElementById('highlighter-mode-btn'),
                eraser: document.getElementById('eraser-mode-btn'),
                select: document.getElementById('select-mode-btn'),
            };

            
            // ** V31.0 æ©¡çš®æ“¦/æ–‡å­—å †ç–Šé‚è¼¯ (ä¿æŒä¸è®Š) **
            canvas.on('path:created', function(e) {
                const path = e.path;
                path.isEraserPath = (currentMode === 'eraser');
                
                if (currentMode === 'eraser') {
                    path.set({ 
                        globalCompositeOperation: 'destination-out',
                        selectable: false,
                        evented: false,
                        stroke: 'rgba(0,0,0,1)' 
                    }); 
                    
                    // å°‡æ©¡çš®æ“¦è·¯å¾‘æåˆ°æ‰€æœ‰éæ–‡å­—ç‰©ä»¶ä¹‹ä¸Š
                    canvas.getObjects().forEach(obj => {
                        if (obj.type !== 'i-text') {
                            canvas.bringToFront(obj);
                        }
                    });
                    canvas.bringToFront(path);
                    
                } else {
                    path.set({ selectable: false, evented: false }); 
                    canvas.bringToFront(path);
                }
                
                // ç¢ºä¿æ‰€æœ‰æ–‡å­—ç‰©ä»¶åœ¨æœ€æœ€é ‚å±¤ (é˜²æ“¦é™¤)
                canvas.getObjects().filter(obj => obj.type === 'i-text').forEach(textObj => {
                    canvas.bringToFront(textObj);
                });

                canvas.renderAll(); 
            });

            // é›™æ“Šæ–‡å­—é€²å…¥ç·¨è¼¯ (ä¿æŒ V31.0 é‚è¼¯)
            canvas.on('mouse:dblclick', function(options) {
                if (options.target && options.target.type === 'i-text') {
                    options.target.enterEditing();
                    canvas.renderAll();
                }
            });


            /**
             * æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ï¼šè¨­å®šå·¥å…·æ¨¡å¼ (é‚è¼¯ä¸è®Š)
             */
            function setToolMode(mode) {
                currentMode = mode;
                
                toolDisplay.textContent = `(${mode.toUpperCase()})`;
                document.querySelectorAll('.tool-selection button').forEach(btn => btn.classList.remove('active'));
                const activeBtn = toolButtons[mode];
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
                
                if (mode === 'select') {
                    canvas.isDrawingMode = false;
                    canvas.selection = true;
                    canvas.forEachObject(obj => {
                        const isSelectable = (obj.type === 'i-text' || (obj.type === 'path' && obj.isEraserPath === false));
                        obj.set({ selectable: isSelectable, evented: isSelectable });
                    });
                    canvas.defaultCursor = 'default';
                    colorEl.disabled = true;
                    widthRangeEl.disabled = true;
                    return; 
                }
                
                canvas.isDrawingMode = true; 
                canvas.selection = false;
                canvas.forEachObject(obj => obj.set({ selectable: false, evented: false })); 
                colorEl.disabled = (mode === 'eraser');
                widthRangeEl.disabled = false;
                canvas.defaultCursor = (mode === 'eraser') ? 'crosshair' : 'default';

                const settings = brushSettings[mode];
                widthRangeEl.value = settings.width;
                widthDisplayEl.textContent = settings.width;
                
                canvas.freeDrawingBrush = settings.brush;
                settings.brush.width = settings.width;
                canvas.freeDrawingBrush.color = settings.color; 
                canvas.freeDrawingBrush.globalCompositeOperation = settings.composite;
                
                if (mode !== 'eraser') {
                    colorEl.value = settings.color.substring(0, 7); 
                }
            }
            
            // --- å…¶ä»–äº‹ä»¶ç›£è½å™¨ (ä¿æŒV31.0ä¸€è‡´) ---
            toolButtons.brush.addEventListener('click', () => setToolMode('brush'));
            toolButtons.highlighter.addEventListener('click', () => setToolMode('highlighter'));
            toolButtons.eraser.addEventListener('click', () => setToolMode('eraser'));
            toolButtons.select.addEventListener('click', () => setToolMode('select'));
            
            // ... (é¡è‰²ã€ç²—ç´°ã€åº•åœ–ã€æ¸…é™¤ã€æ–‡å­—æ’å…¥ã€åˆªé™¤é‚è¼¯ä¿æŒä¸è®Š) ...
            
            document.getElementById('drawing-color').addEventListener('change', function() {
                if (currentMode === 'brush' || currentMode === 'highlighter') {
                    const newColor = this.value;
                    let finalColor = newColor;
                    if (currentMode === 'highlighter') {
                        finalColor = newColor + '80';
                    }
                    brushSettings[currentMode].color = finalColor;
                    canvas.freeDrawingBrush.color = finalColor; 
                }
            });

            document.getElementById('line-width').addEventListener('input', function() {
                const width = parseInt(this.value, 10) || 1;
                widthDisplayEl.textContent = width;
                brushSettings[currentMode].width = width;
                canvas.freeDrawingBrush.width = width;
            });

            document.querySelectorAll('.color-palette-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const target = this.dataset.target;
                    const newColor = this.dataset.color;
                    if (target === 'highlighter') {
                        brushSettings.highlighter.color = newColor + '80';
                        brushSettings.highlighter.width = 30;
                        setToolMode('highlighter');
                    } else {
                        brushSettings.brush.color = newColor;
                        brushSettings.brush.width = 5;
                        setToolMode('brush');
                    }
                });
            });

            document.getElementById('background-image-input').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(f) {
                    canvasContainer.style.backgroundImage = `url(${f.target.result})`;
                    canvas.backgroundColor = 'transparent';
                    canvas.renderAll(); 
                };
                reader.readAsDataURL(file);
            });

            document.getElementById('clear-background-btn').addEventListener('click', function() {
                canvasContainer.style.backgroundImage = 'none';
                canvas.backgroundColor = '#ffffff'; 
                canvas.renderAll();
            });

            document.getElementById('clear-all-drawings-btn').addEventListener('click', function() {
                const objectsToRemove = canvas.getObjects().filter(obj => 
                    (obj.type === 'path' || obj.type === 'i-text')
                );
                canvas.remove(...objectsToRemove);
                canvas.renderAll();
            });

            document.getElementById('add-text-btn').addEventListener('click', function() {
                setToolMode('select'); 
                const text = new fabric.IText('é»æ“Šè¼¸å…¥æ–‡å­—', { 
                    left: 50, top: 50, fontSize: 24, fill: '#333333', editable: true,
                });
                canvas.add(text);
                canvas.setActiveObject(text);
                canvas.bringToFront(text); 
                text.enterEditing(); 
                canvas.renderAll();
            });

            const deleteSelectedBtn = document.getElementById('delete-selected-btn');
            deleteSelectedBtn.addEventListener('click', function() {
                const activeObjects = canvas.getActiveObjects();
                if (activeObjects.length > 0) {
                    canvas.remove(...activeObjects);
                    canvas.discardActiveObject().renderAll();
                }
            });

            document.addEventListener('keydown', (e) => {
                const activeObject = canvas.getActiveObject();
                if ((e.key === 'Delete' || e.key === 'Backspace') && activeObject && (!activeObject.isEditing || activeObject.type !== 'i-text')) {
                    deleteSelectedBtn.click();
                    e.preventDefault();
                }
            });

// ** V33.0 å„²å­˜åœ–ç‰‡åŠŸèƒ½æ ¸å¿ƒä¿®æ­£ï¼šç²¾æº–å¿«ç…§èˆ‡å®Œæ•´æ¢å¾© **
            saveImageBtn.addEventListener('click', async function() { 
                if (typeof html2canvas === 'undefined') {
                    alert("éŒ¯èª¤: html2canvas åº«æœªè¼‰å…¥ï¼Œç„¡æ³•åŸ·è¡Œæˆªåœ–åŠŸèƒ½ã€‚");
                    return;
                }
                
                saveImageBtn.disabled = true;
                setToolMode('select'); // é€€å‡ºç¹ªåœ–æ¨¡å¼

                // 1. å„²å­˜åŸå§‹ç•«å¸ƒç‹€æ…‹å’Œé¸ä¸­ç‹€æ…‹
                const originalCanvasJSON = canvas.toJSON(['isEraserPath']);
                canvas.discardActiveObject(); // ç¢ºä¿ä¸æœƒæˆªåˆ°é¸ä¸­æ¡†
                
                // 2. æ‰¾å‡ºéœ€è¦å›ºåŒ–çš„ç‰©ä»¶ï¼ˆç­†è·¡å’Œæ©¡çš®æ“¦è·¯å¾‘ï¼‰å’Œéœ€è¦ä¿ç•™çš„ç‰©ä»¶ï¼ˆæ–‡å­—ï¼‰
                const nonTextObjects = canvas.getObjects().filter(obj => obj.type !== 'i-text');
                const textObjects = canvas.getObjects().filter(obj => obj.type === 'i-text');
                
                let snapshotImage = null;

                if (nonTextObjects.length > 0) {
                    // 3. ç”Ÿæˆå¿«ç…§ï¼šåªåŒ…å«ç­†è·¡å’Œæ©¡çš®æ“¦è·¯å¾‘
                    // æš«æ™‚å°‡æ‰€æœ‰æ–‡å­—ç‰©ä»¶å¾ç•«å¸ƒä¸­ç§»é™¤
                    canvas.remove(...textObjects);
                    canvas.renderAll(); 

                    const drawingSnapshotURL = canvas.toDataURL({
                        format: 'png',
                        multiplier: 2 // æé«˜å›ºåŒ–åœ–ç‰‡çš„è§£æåº¦
                    });

                    // é‡æ–°å°‡æ–‡å­—ç‰©ä»¶åŠ å›ä¾†ï¼Œæº–å‚™æ¢å¾©
                    canvas.add(...textObjects);
                    canvas.renderAll(); 

                    // 4. å°‡å¿«ç…§è½‰ç‚º fabric.Image ç‰©ä»¶
                    snapshotImage = await new Promise(resolve => {
                        fabric.Image.fromURL(drawingSnapshotURL, img => {
                            img.set({
                                left: 0, top: 0,
                                selectable: false, evented: false,
                                originX: 'left', originY: 'top',
                                scaleX: canvas.width / img.width,
                                scaleY: canvas.height / img.height
                            });
                            resolve(img);
                        });
                    });
                }
                
                // 5. æº–å‚™æˆªåœ–ç•«å¸ƒï¼š
                
                // å„²å­˜ç•¶å‰ç•«å¸ƒä¸Šçš„ç‰©ä»¶åˆ—è¡¨ (ç”¨æ–¼å¾ŒçºŒæ¢å¾©)
                const objectsBeforeCleanup = canvas.getObjects().slice();
                
                // æ¸…ç©ºç•«å¸ƒï¼Œæº–å‚™åŠ å…¥å¿«ç…§å’Œæ–‡å­—
                canvas.clear(); 
                
                if (snapshotImage) {
                    canvas.add(snapshotImage);
                    canvas.sendToBack(snapshotImage); // é€åˆ°åº•å±¤
                }

                // é‡æ–°å°‡æ–‡å­—ç‰©ä»¶åŠ å›ç•«å¸ƒ
                textObjects.forEach(text => {
                    canvas.add(text);
                    canvas.bringToFront(text);
                });
                
                canvas.renderAll(); // æ¸²æŸ“æˆªåœ–æº–å‚™ç•«é¢
                
                // 6. åŸ·è¡Œ html2canvas æˆªåœ–
                try {
                    const canvasShot = await html2canvas(canvasContainer, {
                        useCORS: true, 
                        scale: 2, 
                        logging: false 
                    });

                    // 7. å„²å­˜åœ–ç‰‡ (V31.0 é‚è¼¯ä¸è®Š)
                    const dataURL = canvasShot.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.href = dataURL;
                    link.download = `drawing-${Date.now()}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                } catch (error) {
                    alert("æˆªåœ–å¤±æ•—ã€‚è«‹ç¢ºèªç€è¦½å™¨æ”¯æ´æˆ–åœ–ç‰‡ä¾†æºæ˜¯å¦å…è¨±è·¨åŸŸå­˜å–ã€‚");
                    console.error("æˆªåœ–éŒ¯èª¤:", error);
                }

                // 8. æ¢å¾©åŸå§‹ç‹€æ…‹ï¼šä½¿ç”¨ JSON å®Œæ•´é‚„åŸ
                canvas.clear(); // å†æ¬¡æ¸…ç©ºï¼Œä»¥ç¢ºä¿ loadFromJSON æ˜¯ä¹¾æ·¨çš„è¼‰å…¥
                canvas.loadFromJSON(originalCanvasJSON, () => {
                    canvas.renderAll();
                    // V31.0 çš„æ¿€æ´»ç‰©ä»¶æ¢å¾©é‚è¼¯è¢«çœç•¥ï¼Œå› ç‚º loadFromJSON æœƒè™•ç†
                    saveImageBtn.disabled = false;
                    console.log("ç•«å¸ƒå·²å¾åŸå§‹ç‹€æ…‹ JSON å®Œæ•´æ¢å¾©ã€‚");
                });
            });


            // åˆå§‹è¼‰å…¥
            setToolMode('brush');
            canvasContainer.style.backgroundColor = '#ffffff'; 
            canvas.renderAll();
        });
    </script>

</body>
</html>
